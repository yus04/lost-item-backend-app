import os
import json
import azure.functions as func
import logging
from openai import AzureOpenAI

app = func.FunctionApp(http_auth_level=func.AuthLevel.ANONYMOUS)

AZURE_OPENAI_SERVICE = os.environ.get("AZURE_OPENAI_SERVICE")
AZURE_OPENAI_API_VERSION = os.getenv("AZURE_OPENAI_API_VERSION")
GPT_DEPLOYMENT = os.environ.get("GPT_DEPLOYMENT")
AZURE_OPENAI_TOKEN = os.environ.get("AZURE_OPENAI_TOKEN")

openai_client = AzureOpenAI(
    azure_endpoint = f"https://{AZURE_OPENAI_SERVICE}.openai.azure.com",
    api_version=AZURE_OPENAI_API_VERSION,
    api_key = AZURE_OPENAI_TOKEN
)

# @app.route(route="http_trigger")
# def http_trigger(req: func.HttpRequest) -> func.HttpResponse:
#     req_body = json.loads(req.get_body())
#     messages = [
#         {"role":"system","content":"あなたは落とし物の種類を判別できます。落とし物の種類だけを回答してください。"},
#         {"role":"user","content":[
#             {
#                 "type": "text",
#                 "text": "この写真に映っている落とし物の種類を判別してください。"
#             },
#             {
#                 "type": "image_url",
#                 "image_url": req_body.get("image_file_path")
#             }
#         ]}
#     ]
#     response = openai_client.chat.completions.create(
#         model=GPT_DEPLOYMENT,
#         messages=messages,
#         temperature=0.0,
#         max_tokens=1000,
#         n=1
#     )

#     answer = response.choices[0].message.content

#     response_data = {
#         "answer": answer
#     }

#     return func.HttpResponse(
#         body=json.dumps(response_data),
#         status_code=200
#     )

@app.route(route="http_trigger")
def http_trigger(req: func.HttpRequest) -> func.HttpResponse:
    req_body = json.loads(req.get_body())
    messages = [
        {"role":"system","content":"""
            あなたは遺失物管理サービスの担当者です。
            ユーザーから提示される画像は落とし物です。
            遺失物管理システムに登録するための特徴を読み取ってください。
            読み取った特徴をマークダウンの箇条書き形式で出力してください。
            次に落とし物が該当するカテゴリーに分類してください。
            カテゴリーは 大分類、分類、項目で定義されており、適切なものを選択してください。
            回答は日本語で生成してください。

            ### カテゴリー

            - 現金
            - 現金
                - 現金
            - かばん類
            - 手提げかばん
                - ハンドバッグ
                - ビジネスバッグ
                - トートバッグ
                - ボストンバッグ
                - スポーツバッグ
                - アタッシュケース
                - トランク
                - シューズバッグ
                - 学生かばん
                - 手提げかばん
                - 手提げかばん）その他
            - 肩掛けかばん
                - ショルダーバッグ
                - リュックサック
                - デイパック
                - 肩掛けかばん
                - 肩掛けかばん）その他
            - 抱えかばん
                - セカンドバッグ
                - 抱えかばん
                - 抱えかばん）その他
            - 小物入れ
                - ポーチ
                - ウエストポーチ
                - ポシェット
                - きんちゃく
                - たばこ入れ
                - 小物入れ
                - 印鑑入れ
                - 小物入れ）その他
            - その他かばん類
                - スーツケース
                - ハンガーケース
                - かばん類）その他
            - 袋・封筒類
            - 袋
                - 手提げ袋（ビニール）
                - 手提げ袋（紙）
                - レジ袋
                - ビニール袋
                - 紙袋
                - 布袋
                - エコバック
                - 袋）その他
            - 封筒
                - お年玉袋
                - のし袋
                - 薬袋
                - 書類袋
                - 名入り封筒
                - 封筒
                - 封筒）その他
            - 財布類
            - 財布
                - 札入れ
                - 財布
                - 財布）その他
            - がま口
                - がま口
                - がま口）その他
            - 小銭入れ
                - 小銭入れ（チャック式）
                - 小銭入れ（ホック式）
                - 小銭入れ
                - コインケース
                - 小銭入れ）その他
            - カードケース類
            - カードケース
                - 定期券入れ
                - 免許証入れ
                - カード入れ
                - カードケース）その他
            - 名刺入れ
                - 名刺入れ
                - 名刺入れ）その他
            - カメラ類
            - カメラ
                - デジタルカメラ
                - コンパクトカメラ
                - 一眼レフカメラ
                - 使い捨てカメラ
                - カメラ）その他
            - ビデオカメラ
                - デジタルビデオカメラ
                - ビデオカメラ
                - ビデオカメラ）その他
            - カメラ付属品類
                - カメラケース
                - フィルム
                - 三脚
                - カメラレンズ
                - カメラ付属品類）その他
            - 時計類
            - 腕時計
                - 腕時計男性用（金属製ベルト）
                - 腕時計女性用（金属製ベルト）
                - 腕時計男性用（革製ベルト）
                - 腕時計女性用（革製ベルト）
                - 腕時計男性用（その他ベルト）
                - 腕時計女性用（その他ベルト）
                - 腕時計（金属製ベルト）
                - 腕時計（革製ベルト）
                - 腕時計（その他ベルト）
                - 腕時計）その他
            - その他時計類
                - 置時計
                - 懐中時計
                - 壁掛時計
                - 時計類）その他
            - めがね類
            - めがね
                - めがね（ケースなし）
                - めがね（ケースあり）
                - めがね）その他
            - サングラス類
                - サングラス
                - ゴーグル
                - サングラス類）その他
            - コンタクトレンズ
                - コンタクトレンズ
                - コンタクトレンズ）その他
            - 双眼鏡類
                - 双眼鏡
                - レンズ
                - ルーペ
                - 双眼鏡類）その他
            - 電気製品類
            - 電気製品
                - 防犯ブザー
                - ライト
                - 電気かみそり
                - ＤＶＤプレーヤー
                - ドライヤー
                - 電球
                - ブルーレイディスクプレーヤー
                - 電気製品）その他
            - 携帯音響品
                - ＭＰ３プレーヤー
                - デジタルオーディオプレーヤー
                - 携帯ラジオ
                - ＭＤプレーヤー
                - ＣＤプレーヤー
                - ｉＰｏｄ
                - ウォークマン
                - 携帯音響品）その他
            - 音響関連品
                - イヤホン
                - ヘッドホン
                - マイク
                - 音響関連品）その他
            - 電子機器
                - ノートパソコン
                - 電卓
                - 電子辞書
                - 電子手帳
                - パソコンソフト
                - マウスパッド
                - 電子機器）その他
            - 電子玩具
                - ゲーム機
                - ゲームソフト
                - 電子玩具）その他
            - 外部記録媒体
                - ＦＤ
                - ＵＳＢメモリー
                - メモリーカード
                - ビデオテープ
                - カセットテープ
                - ＤＶＤ
                - ＣＤ
                - ＭＤ
                - ブルーレイ
                - 外部記録媒体）その他
            - 電気製品類付属品
                - 充電器
                - 電池
                - アダプター
                - コード
                - 電気製品類付属品）その他
            - 携帯電話類
            - 携帯電話機
                - 携帯電話機
                - ポケットベル
                - スマートフォン
                - 携帯電話機）その他
            - その他通信機器類
                - 位置情報携帯端末
                - タブレット端末
                - 通信機器類）その他
            - 貴金属類
            - ネックレス
                - ネックレス
                - ネックレス）その他
            - 指輪
                - 指輪（石つき）
                - 指輪（石なし）
                - 指輪）その他
            - ブレスレット
                - ブレスレット
                - ブレスレット）その他
            - イヤリング類
                - ピアス
                - イヤリング
                - イヤリング類）その他
            - ブローチ
                - ブローチ
                - ブローチ）その他
            - ペンダント
                - ペンダント
                - ペンダント）その他
            - その他貴金属類
                - 金地金
                - 貴金属類）その他
            - 趣味・娯楽用品類
            - レジャー・スポーツ用品
                - グローブ
                - ゴルフバッグ
                - ゴルフクラブ
                - テニスラケット
                - スケートボード
                - 浮き輪
                - 釣り竿
                - 釣り道具
                - クーラーボックス
                - レジャー・スポーツ）その他
            - 楽器類
                - ギター
                - 笛
                - フルート
                - 楽器類）その他
            - その他趣味・娯楽用品類
                - おもちゃ
                - ぬいぐるみ
                - ゲームカード
                - 人形
                - トランプ
                - キックボード
                - 趣味・娯楽用品類）その他
            - 証明書類・カード類
            - 運転免許証
                - 運転免許証
                - 仮運転免許証
                - 国際免許証
                - 運転免許証）その他
            - 身分証明書類
                - 学生証
                - 生徒証
                - 従業員証
                - 会社員証
                - 外国人登録証
                - パスポート
                - 身分証明書
                - 運転経歴証明書
                - 入門証
                - 身分証明書類）その他
            - 健康保険証類
                - 国民健康保険証
                - 社会保険証
                - 共済組合員証
                - 老人医療証
                - 乳児医療証
                - 診察券
                - 健康保険証
                - 後期高齢者医療被保険者証
                - 健康保険証類）その他
            - その他証明書類
                - 身体障害者手帳
                - 母子手帳
                - 年金手帳
                - 献血手帳
                - 雇用保険被保険者証
                - 印鑑登録証
                - 印鑑登録証明書
                - 住民票
                - 住民基本台帳カード
                - 自動車検査証
                - ナンバープレート
                - 自賠責保険証
                - 生命保険証
                - 傷害保険証
                - 船舶免許証
                - 無線免許証
                - クレーン免許証
                - 宅地建物取扱主任者証
                - 通行証
                - 証明書類）その他
            - 預貯金通帳類
                - 預貯金通帳
                - 預貯金証書
                - 預貯金通帳類）その他
            - キャッシュカード類
                - キャッシュカード
                - クレジットカード
                - ＥＴＣカード
                - 電子マネーカード（クレジット）
                - キャッシュカード類）その他
            - 会員証（カード）類
                - メンバーズカード
                - ポイントカード
                - 図書館利用者カード
                - ビデオレンタルカード
                - 振込カード
                - 給油カード
                - 受講カード
                - ｔａｓｐｏ
                - 会員証（カード）類）その他
            - 有価証券類
            - 有価証券
                - 商品券
                - 図書券
                - 会員券
                - ギフト券
                - ビール券
                - 小切手
                - 株券
                - 図書カード
                - 有価証券）その他
            - プリペイドカード類
                - テレホンカード
                - パスネット
                - バスカード
                - Ｓｕｉｃａ
                - ＩＣＯＣＡ
                - ＰＡＳＭＯ
                - オレンジカード
                - ＩＣいーカード
                - 電子マネーカード
                - プリペイドカード類）その他
            - 定期券類
                - 定期券
                - Ｓｕｉｃａ定期
                - ＩＣＯＣＡ定期
                - ＰＡＳＭＯ定期
                - シルバーパス
                - 身体障害者無料乗車証
                - 株主優待乗車証
                - ＩＣいーカード定期
                - 定期券類）その他
            - 乗車券類
                - 回数券
                - 乗車券
                - 航空券
                - 乗船券
                - 乗車券類）その他
            - 馬券・宝くじ類
                - 宝くじ
                - 馬券
                - 車券
                - 船券
                - 馬券・宝くじ類）その他
            - 切手類
                - 郵便切手
                - 収入印紙
                - 未使用郵便はがき
                - 切手類）その他
            - その他証券類
                - 損傷紙幣
                - 外国通貨
                - 古銭・旧通貨
                - 入場券
                - 証券類）その他
            - 著作品類
            - 書籍類
                - 文庫本
                - 雑誌
                - 単行本
                - 時刻表
                - マンガ本
                - 教科書
                - 冊子
                - 地図
                - 書籍類）その他
            - ディスク・テープ類
                - ビデオソフト
                - ＣＤソフト
                - ＭＤソフト
                - ＤＶＤソフト
                - ブルーレイディスクソフト
                - ディスク・テープ類）その他
            - 写真類
                - 写真
                - ネガ
                - 写真パネル
                - 写真類）その他
            - その他著作品類
                - 絵画
                - 版画
                - 著作品類）その他
            - 手帳・文具類
            - 手帳・ノート類
                - 手帳
                - アドレス帳
                - ノート
                - システム手帳
                - 手帳・ノート類）その他
            - 印鑑類
                - 印鑑
                - 朱肉
                - 印鑑類）その他
            - 整理収納用品類
                - ビニールケース
                - クリアーファイル
                - 書類入れ
                - バインダー
                - アルバム
                - クリアーケース
                - プラスチックケース
                - 手提げ金庫
                - 整理収納用品類）その他
            - 筆箱・筆記用具類
                - ボールペン
                - 筆入れ
                - 筆箱・筆記用具類）その他
            - その他文具類
                - カッターナイフ
                - 定規
                - 文具類）その他
            - 書類・紙類
            - 書類
                - 領収書
                - 明細書
                - 契約書
                - 履歴書
                - 受領書
                - 保証書
                - 注文書
                - 資料
                - 賞状
                - 書類）その他
            - 図画類
                - 建築図面
                - 電気図面
                - カレンダー
                - パンフレット
                - カタログ
                - 設備図面
                - 図画類）その他
            - 名刺
                - 名刺
                - 名刺）その他
            - その他紙類
                - レシート
                - 割引券
                - 使用済郵便はがき
                - 振込用紙
                - 手紙
                - 駐車券
                - 食券
                - 紙類）その他
            - 小包・箱類
            - 小包・箱類
                - ダンボール箱
                - 箱
                - 菓子箱
                - 宅配物
                - 郵便小包
                - キャリー
                - 小包・箱類）その他
            - 衣類・履物類
            - 帽子類
                - ヘルメット
                - サンバイザー
                - 野球帽
                - 耳あて
                - 帽子
                - 帽子類）その他
            - 手袋
                - 手袋（両手）
                - 手袋（片手）
                - 手袋）その他
            - マフラー類
                - マフラー
                - スカーフ
                - ショール
                - ストール
                - ひざ掛け
                - ネックウォーマー
                - マフラー類）その他
            - 上着類
                - ジャンパー
                - ジャケット
                - カーディガン
                - Ｔシャツ
                - ワイシャツ
                - ブラウス
                - セーター
                - トレーナー
                - ベスト
                - コート
                - パーカー
                - 上着類）その他
            - ズボン類
                - ズボン
                - ジーパン
                - スカート
                - ズボン類）その他
            - 上下衣類
                - スーツ
                - ワンピース
                - 作業着
                - 制服
                - 白衣
                - 柔道着
                - ウインドブレーカー
                - スポーツウェア
                - 合羽
                - 着物
                - 上下衣類）その他
            - その他衣類
                - 下着類
                - 水着
                - ネクタイ
                - エプロン
                - バンダナ
                - パジャマ
                - 靴下
                - 衣類）その他
            - 衣類付属品
                - ベルト
                - バックル
                - ネクタイピン
                - カフスボタン
                - ボタン
                - 衣類付属品）その他
            - 履物類
                - 上履き
                - ランニングシューズ
                - サンダル
                - スリッパ
                - 靴
                - 履物類）その他
            - かさ類
            - かさ
                - 長傘
                - 折りたたみ傘
                - ビニール傘
                - かさ）その他
            - 鍵類
            - 鍵
                - 自動車用鍵
                - 自転車用鍵
                - 家用鍵
                - バイク用鍵
                - その他鍵
            - 鍵（キーホルダー付）
                - 自動車用鍵（キーホルダー）
                - 自転車用鍵（キーホルダー）
                - 家用鍵（キーホルダー）
                - バイク用鍵（キーホルダー）
                - その他鍵（キーホルダー）
            - 鍵（キーケース付）
                - 自動車用鍵（キーケース）
                - 自転車用鍵（キーケース）
                - 家用鍵（キーケース）
                - バイク用鍵（キーケース）
                - その他鍵（キーケース）
            - カードキー
                - セキュリティカード
                - ＩＣカード
                - 入室カード
                - カードキー）その他
            - 生活用品類
            - 生活用品
                - タオル
                - ハンカチ
                - ライター
                - 灰皿
                - キーホルダー
                - ストラップ
                - ティッシュペーパー
                - くし
                - 洗面具
                - 鏡
                - 石鹸
                - 紙おむつ
                - 扇子
                - 風呂敷
                - クッション
                - 枕
                - 生活用品）その他
            - 食器類
                - 水筒
                - 弁当箱
                - 包丁
                - 食品保存容器
                - 皿
                - 食器類）その他
            - 工具類
                - ドライバー
                - ペンチ
                - レンチ
                - 工具類）その他
            - 装飾品類
                - 名札
                - 腕章
                - バッチ
                - ヘアピン
                - かんざし
                - コサージュ
                - リストバンド
                - 装飾品類）その他
            - 神仏具品類
                - お守り
                - 数珠
                - おみくじ
                - お骨
                - 神仏具品類）その他
            - 自転車類
                - 自転車
                - キャリアカート
                - ベビーカー
                - 台車
                - タイヤ
                - バイク
                - 自転車類）その他
            - ケース・カバー類
                - めがねケース
                - キーケース
                - ペットボトルケース
                - ティッシュケース
                - 傘カバー
                - ケース・カバー類）その他
            - 医療・化粧品類
            - 薬類
                - 絆創膏
                - コンタクト洗浄液
                - 薬
                - 救急箱
                - 薬類）その他
            - 医療関連品類
                - 杖
                - 万歩計
                - 入れ歯
                - 補聴器
                - 医療関連品類）その他
            - 化粧品類
                - 口紅
                - 香水
                - コンパクト
                - 化粧品
                - 化粧品類）その他
            - 食料品類
            - 食料品類
                - 食品
                - 飲料品
                - 酒
                - たばこ
                - 食料品類）その他
            - 動植物類
            - 動物
                - 犬
                - ねこ
                - ほ乳類
                - は虫類
                - 両生類
                - 動物）その他
            - 植物
                - 花束
                - 鉢植え
                - 植物）その他
            - 動植物関連品
                - 虫かご
                - 鳥かご
                - ペットフード
                - 肥料
                - 首輪
                - 動植物関連品）その他
            - その他
            - 所持禁止物品
                - けん銃
                - 刀
                - 覚せい剤
                - 刀（禁制品以外）
                - 所持禁止物品）その他
            - その他
                - 土器・石器
                - 金庫
                - 消火器
                - 薬品
                - 看板
                - その他
                - 物品
            """},
        {"role":"user","content":[
            {
                "type": "image_url",
                "image_url": req_body.get("image_file_path")
            }
        ]}
    ]
    response = openai_client.chat.completions.create(
        model=GPT_DEPLOYMENT,
        messages=messages,
        temperature=0.0,
        max_tokens=1000,
        n=1
    )

    answer = response.choices[0].message.content

    response_data = {
        "answer": answer
    }

    return func.HttpResponse(
        body=json.dumps(response_data),
        status_code=200
    )